<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>QA DASHBOARD</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  :root{
    --bg:#f5f7fa;
    --card:#ffffff;
    --border:#dbe2ea;
    --accent:#0b63d6;
    --accent-hover:#094faa;
    --danger:#d92d44;
    --danger-hover:#b1142d;
    --text:#0f1c2e;
    --muted:#607182;
    --radius:10px;
    --shadow:0 6px 18px rgba(21,43,72,.08);
    --row-alt:#f9fbfd;
    --pill:#eef5ff;
  }
  *{box-sizing:border-box;font-family:Arial,Helvetica,sans-serif;}
  body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    padding:28px;
    display:flex;
    justify-content:center;
  }
  .page{
    width:100%;
    max-width:1100px;
  }
  h1{
    margin:0 0 18px;
    font-size:24px;
    font-weight:600;
    letter-spacing:.5px;
    background:linear-gradient(90deg,#0b63d6,#53a0fd);
    -webkit-background-clip:text;
    color:transparent;
  }
  form{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding:24px 26px 34px;
    box-shadow:var(--shadow);
  }
  label{display:block;margin-top:12px;font-weight:600;font-size:13.5px;color:var(--text);}
  input[type=date],
  input[type=text],
  input[type=number],
  select,
  textarea{
    width:100%;
    margin-top:6px;
    padding:10px 11px;
    border:1px solid var(--border);
    background:#f9fbfd;
    border-radius:8px;
    font-size:13.5px;
    transition:.15s border, .15s background;
  }
  textarea{min-height:100px;resize:vertical;}
  input:focus,select:focus,textarea:focus{
    outline:none;
    border-color:var(--accent);
    background:#fff;
    box-shadow:0 0 0 3px rgba(11,99,214,.15);
  }
  .row-flex{
    display:flex;
    gap:14px;
    flex-wrap:wrap;
  }
  .row-flex > div{
    flex:1 1 220px;
    min-width:200px;
  }
  hr{
    border:0;
    height:1px;
    background:var(--border);
    margin:30px 0 22px;
  }
  h3{
    margin:0 0 10px;
    font-size:16px;
    font-weight:600;
    color:#18324a;
  }
  button{
    cursor:pointer;
    border:0;
    font-weight:600;
    letter-spacing:.4px;
    border-radius:8px;
    transition:.2s background,.2s box-shadow;
  }
  .btn{
    padding:10px 18px;
    font-size:13.5px;
    background:var(--accent);
    color:#fff;
    box-shadow:0 4px 12px rgba(11,99,214,.25);
  }
  .btn:hover{background:var(--accent-hover);}
  .btn:active{transform:translateY(1px);box-shadow:0 2px 8px rgba(11,99,214,.28);}
  .btn-secondary{
    background:#fff;
    color:var(--accent);
    border:1px solid var(--accent);
    box-shadow:none;
  }
  .btn-secondary:hover{background:var(--pill);}
  .btn-danger{
    background:var(--danger);
    box-shadow:0 4px 12px rgba(217,45,68,.25);
  }
  .btn-danger:hover{background:var(--danger-hover);}
  table{
    width:100%;
    border-collapse:separate;
    border-spacing:0;
    margin-top:14px;
    border:1px solid var(--border);
    border-radius:10px;
    overflow:hidden;
    background:#fff;
  }
  thead th{
    background:#eef5ff;
    color:#0f1c2e;
    font-weight:600;
    font-size:12.5px;
    padding:10px 8px;
    border-bottom:1px solid var(--border);
  }
  tbody td{
    font-size:13px;
    padding:9px 8px;
    border-bottom:1px solid var(--border);
  }
  tbody tr:nth-child(even){background:var(--row-alt);}
  tbody tr:last-child td{border-bottom:0;}
  .remove-btn{
    font-size:11px;
    padding:4px 10px;
    background:var(--danger);
    color:#fff;
    border-radius:6px;
    border:0;
  }
  .remove-btn:hover{background:var(--danger-hover);}
  #status{
    margin-top:16px;
    font-size:13.5px;
    font-weight:600;
  }
  #status.ok{color:#0d8a4b;}
  #status.err{color:var(--danger);}
  .stage-pill{
    display:inline-block;
    background:var(--pill);
    padding:4px 8px;
    border-radius:20px;
    font-size:11px;
    font-weight:600;
    color:var(--accent);
    letter-spacing:.4px;
  }
  .add-section{
    background:#f1f6fc;
    border:1px solid #d7e3f1;
    padding:16px 18px 10px;
    border-radius:10px;
    margin-bottom:4px;
  }
  .tabs{display:flex;gap:10px;margin-bottom:18px;flex-wrap:wrap;}
  .tab-btn{
    flex:1 1 200px;
    padding:10px 0;
    background:#e3edff;
    border:0;
    border-radius:10px;
    font-weight:600;
    color:#0f1c2e;
    cursor:pointer;
  }
  .tab-btn.active{background:#0b63d6;color:#fff;box-shadow:0 4px 12px rgba(11,99,214,.25);}
  .tab-panel{display:none;}
  .tab-panel.active{display:block;}
  .summary-card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding:22px 24px 26px;
    box-shadow:var(--shadow);
  }
  .details-card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding:22px 24px 26px;
    box-shadow:var(--shadow);
    margin-top:16px;
  }
  #summaryTable{width:100%;border-collapse:collapse;margin-top:14px;display:none;}
  #summaryTable th,#summaryTable td{border:1px solid var(--border);padding:8px 10px;text-align:left;font-size:13px;}
  #summaryTable thead{background:#eef5ff;font-weight:600;}
  .brc-info{display:flex;flex-wrap:wrap;gap:14px;margin-top:14px;}
  .brc-card{flex:1 1 220px;background:#eef5ff;border:1px solid #d7e3f1;border-radius:10px;padding:12px 14px;font-size:13px;}
  .brc-card strong{display:block;font-size:12px;color:#0b63d6;margin-bottom:4px;}
  .tracker-options{display:flex;flex-wrap:wrap;gap:16px;margin-top:12px;}
  .tracker-options label{display:flex;align-items:center;gap:8px;font-weight:600;font-size:13px;}
  .note-small{
    font-size:11.5px;
    color:var(--muted);
    margin-top:4px;
  }
  @media (max-width:780px){
    body{padding:18px;}
    form{padding:18px 18px 30px;}
    .row-flex > div{flex:1 1 100%;min-width:100%;}
  }
</style>
</head>
<body>
<div class="page">
  <h1>QA DASHBOARD</h1>

  <div class="tabs">
    <button type="button" class="tab-btn active" data-target="formTab" onclick="switchTab(event)">Rejection Form</button>
    <button type="button" class="tab-btn" data-target="summaryTab" onclick="switchTab(event)">Batch Summary</button>
    <button type="button" class="tab-btn" data-target="brcTab" onclick="switchTab(event)">BRC Tracker</button>
  </div>

  <div id="formTab" class="tab-panel active">
  <form id="mainForm" onsubmit="event.preventDefault(); submitAll();">
    <div class="row-flex">
      <div>
        <label>Date *</label>
        <input type="date" name="Date" required>
      </div>
      <div>
        <label>Shift *</label>
        <select name="Shift" required></select>
      </div>
      <div>
        <label>Line *</label>
        <select name="Line" required onchange="onLineChange(this.value)"></select>
      </div>
      <div>
        <label>Lot No</label>
        <select name="LOT_NO"></select>
      </div>
      <div>
        <label>Batch No</label>
        <input type="text" name="BatchNumber" placeholder="e.g. MVDLR00148">
      </div>
      <div>
        <label>Verified By</label>
        <select name="VerifiedByName"></select>
      </div>
    </div>

    <hr>

    <h3>Add Rejection Item</h3>
    <div class="add-section">
      <div class="row-flex">
        <!-- 1. STAGE -->
        <div>
          <label>Stage</label>
          <select id="categorySelect" onchange="populateTypes()">
            <option value="">--select--</option>
            <option value="VI1_Types">VI-1</option>
            <option value="VI2_Types">VI-2</option>
            <option value="VI3_Types">VI-3</option>
            <option value="Vacuum_Types">VACCUM REJECTIONS</option>
            <option value="VI4_Types">VI-4</option>
          </select>
        </div>
        
        <!-- 2. EQUIPMENT -->
        <div>
          <label>Equipment (VI-1 only)</label>
          <select id="equipmentSelect"></select>
          <div class="note-small" id="equipNote">Select Line first to populate equipment</div>
        </div>
        
        <!-- 3. TYPE -->
        <div>
          <label>Type</label>
          <select id="typeSelect"></select>
        </div>
        
        <!-- 4. CARTRIDGE PART -->
        <div>
          <label>Cartridge Part</label>
          <select id="partSelect"></select>
        </div>
        
        <!-- 5. QTY -->
        <div>
          <label>Qty</label>
          <input type="number" id="qtyInput" min="1" value="1">
        </div>
        
        <div style="align-self:flex-end;display:flex;gap:10px">
          <button type="button" class="btn" onclick="addItem()">Add Item</button>
          <button type="button" class="btn btn-secondary" onclick="resetAddFields()">Clear</button>
        </div>
      </div>
      <div class="note-small">Each added line will be appended as a separate row on submit.</div>
    </div>

    <table id="itemsTable">
      <thead>
        <tr>
          <th>#</th>
          <th>Stage</th>
          <th>Equipment</th>
          <th>Type</th>
          <th>Part</th>
          <th>Qty</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div style="display:flex;justify-content:flex-end;gap:12px;margin-top:24px">
      <button type="submit" class="btn">Submit All</button>
      <button type="button" class="btn btn-secondary" onclick="formReset()">Reset Form</button>
    </div>
    <div id="status">Ready</div>
  </form>
  </div>

  <div id="summaryTab" class="tab-panel">
    <div class="summary-card">
      <div class="row-flex">
        <div>
          <label>Batch No *</label>
          <input type="text" id="summaryBatch" placeholder="e.g. MVDLR00148">
        </div>
        <div style="align-self:flex-end">
          <button type="button" class="btn" onclick="fetchSummary()">Show Summary</button>
        </div>
      </div>
      <div id="summaryStatus" class="note-small" style="margin-top:10px">Enter batch number to view totals.</div>
      <table id="summaryTable">
        <thead><tr><th>Stage</th><th>Qty</th></tr></thead>
        <tbody></tbody>
        <tfoot><tr><th>Total</th><th id="summaryTotal">0</th></tr></tfoot>
      </table>
    </div>
  </div>

  <div id="brcTab" class="tab-panel">
    <div class="summary-card">
      <div class="row-flex">
        <div>
          <label>Batch No *</label>
          <input type="text" id="brcBatch" placeholder="e.g. MVDLR00148">
        </div>
        <div style="align-self:flex-end">
          <button type="button" class="btn" onclick="fetchBrcStatus()">Check BRC Status</button>
        </div>
      </div>
      <div id="brcStatusMessage" class="note-small" style="margin-top:10px">Enter batch number to check BRC status.</div>
      <div id="brcDetails" class="brc-info" style="display:none">
        <div class="brc-card">
          <strong>Status</strong>
          <span id="brcStatusValue">-</span>
        </div>
        <div class="brc-card">
          <strong>Remarks</strong>
          <span id="brcRemarksValue">-</span>
        </div>
        <div class="brc-card">
          <strong>Updated On</strong>
          <span id="brcUpdatedValue">-</span>
        </div>
      </div>
    </div>
    <div id="batchDetailsSection" class="details-card" style="display:none">
      <h3>Batch Details Entries</h3>
      <div class="row-flex">
        <div>
          <label>Incident number</label>
          <input type="text" id="incidentInput" placeholder="e.g. INC-001">
        </div>
        <div>
          <label>Deviation number</label>
          <input type="text" id="deviationInput" placeholder="e.g. DEV-001">
        </div>
        <div>
          <label>CA number</label>
          <input type="text" id="caInput" placeholder="e.g. CA-001">
        </div>
        <div>
          <label>PA number</label>
          <input type="text" id="paInput" placeholder="e.g. PA-001">
        </div>
        <div>
          <label>OOS number</label>
          <input type="text" id="oosInput" placeholder="e.g. OOS-001">
        </div>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:12px;margin-top:16px">
        <button type="button" class="btn" onclick="saveBatchDetails()">Save Details</button>
        <button type="button" class="btn btn-secondary" onclick="resetBatchDetailsForm()">Clear</button>
      </div>
      <div id="batchDetailsStatus" class="note-small" style="margin-top:8px">Load a batch to edit details.</div>
    </div>
    <div id="trackerSection" class="details-card" style="display:none">
      <h3>BRC Documents Checklist</h3>
      <div class="tracker-options">
        <label><input type="checkbox" id="brcSubmittedChk"> BRC Submitted</label>
        <label><input type="checkbox" id="gdpCompletedChk"> GDP Completed</label>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:12px;margin-top:16px">
        <button type="button" class="btn" onclick="saveBrcTrackerStatus()">Save Tracker</button>
      </div>
      <div id="trackerStatusMsg" class="note-small" style="margin-top:8px">Load a batch to update tracker.</div>
    </div>
  </div>
</div>

<script>
  const DEFAULT_LOOKUPS = {
    Shift:["A-SHIFT","B-SHIFT","C-SHIFT","GENERAL"],
    LOT_NO:["NA","LOT-1","LOT-2","LOT-3","LOT-4","LOT-5"],
    Line:["LINE-A","LINE-B","LINE-C","LINE-D","LINE-E","AUTOMATION LINE"],
    VI1_Types:["WEAK WELD","DUST WELD","IMPROPER WELD","AIR BUBBLES","DAMAGE","NARROW CHANNEL","ALIGNMENT ISSUE","QC TORQUE TEST","CHILD PARTS WELDED","HAIR WELD","DUMP REJECTIONS","OIL","BULGING","NA"],
    VI2_Types:["WEAK WELD","DUST WELD","IMPROPER WELD","AIR BUBBLES","DAMAGE","ALIGNMENT ISSUE","WHITE LINE","NA"],
    VI3_Types:["PEAL OFF","TEAR OFF","DAMAGE","DUST WELD","WELDING REJECTIONS","OVERMELT","NA"],
    Vacuum_Types:["EN 6 LEAK","EN 4 LEAK","SN LOW","SN HIGH","EN LOW","EN HIGH","QR REJECTIONS","CLOCKED ERROR","NA"],
    VI4_Types:["IMPROPER WELDING","WEAK WELDING","DUST WELD","ALIGNMENT ISSUE","QR REJECTIONS","DAMAGE","OVERMELT","NARROW CHANNEL","MATRIC REJECTIONS","SEALING REJECTIONS","AIR BUBBLES","WELDING REJECTIONS","NA"],
    Equipment_LINE_A:["EC/EQID/III-00631","EC/EQID/III-00163"],
    Equipment_LINE_B:["EC/EQID/III-00572","EC/EQID/III-00133"],
    Equipment_LINE_C:["EC/EQID/III-00069","EC/EQID/III-00101"],
    Equipment_LINE_D:["EC/EQID/III-00003","EC/EQID/III-00633"],
    Equipment_LINE_E:["EC/EQID/III-00036","EC/EQID/III-00632"],
    Equipment_AUTOMATION_LINE:["EC/EQID/III-00659"],
    CartridgePart:["NA","ELUTE SIDE","MATRIX SIDE","SAMPLE FILETER SIDE","DUMP SIDE","FILTER RODS SIDE","SAMPLE FILTER BOTTOM","IN CHANNEL","QR CODE"],
    VerifiedByName:["L R NAIDU","KAUSHIK","SAI KUMAR","SRINU","ROHINI","NARENDRA","RAJU","CHAKRADHAR"]
  };
  const catMap = {"VI1_Types":"VI-1","VI2_Types":"VI-2","VI3_Types":"VI-3","Vacuum_Types":"VACCUM REJECTIONS","VI4_Types":"VI-4"};
  let lookups = DEFAULT_LOOKUPS;
  let items = [];
  let lookupsReady = false;
  let currentBrcBatch = '';

  function fillSelect(name, arr){
    const el=document.querySelector(`[name="${name}"]`);
    if(!el)return;
    const options = Array.isArray(arr)?arr:[];
    el.innerHTML='<option value="">--select--</option>'+options.map(v=>`<option value="${v}">${v}</option>`).join('');
  }

  function getEquipmentKey(line){
    // Convert spaces and hyphens to underscores to match keys like Equipment_LINE_A
    if(!line) return '';
    return 'Equipment_' + line.trim().replace(/[- ]/g,'_');
  }

  function init(){
    setStatus('Loading lookups...');
    google.script.run.withSuccessHandler(data=>{
      lookups = data || DEFAULT_LOOKUPS;
      lookupsReady = true;
      hydrateForm();
      setStatus('Ready',true);
    }).withFailureHandler(err=>{
      console.error('Lookup load failed',err);
      lookups = DEFAULT_LOOKUPS;
      lookupsReady = true;
      hydrateForm();
      setStatus('Using default lookup list');
    }).getLookupData();
    document.getElementById('equipmentSelect').disabled=true;
  }

  function hydrateForm(){
    fillSelect('Shift',lookups.Shift);
    fillSelect('LOT_NO',lookups.LOT_NO);
    fillSelect('Line',lookups.Line);
    fillSelect('VerifiedByName',lookups.VerifiedByName);
    const partSel = document.getElementById('partSelect');
    partSel.innerHTML='<option value="">--select--</option>'+(lookups.CartridgePart||[]).map(v=>`<option value="${v}">${v}</option>`).join('');
    const d=new Date(); document.querySelector('[name="Date"]').value=d.toISOString().slice(0,10);
    renderItems();
  }

  function onLineChange(line){
    if(!lookupsReady) return;
    const key = getEquipmentKey(line);
    const sel = document.getElementById('equipmentSelect');
    const arr = lookups[key] || [];
    sel.innerHTML = '<option value="">--select--</option>' + arr.map(v=>`<option value="${v}">${v}</option>`).join('');
    updateEquipNote();
  }

  function populateTypes(){
    const cat=document.getElementById('categorySelect').value;
    if(!lookupsReady) return;
    const sel=document.getElementById('typeSelect');
    const arr=lookups[cat]||[];
    sel.innerHTML='<option value="">--select--</option>'+arr.map(v=>`<option value="${v}">${v}</option>`).join('');
    // Re-run equipment state (line may already be chosen)
    updateEquipNote();
  }

  function updateEquipNote(){
    const cat=document.getElementById('categorySelect').value;
    const line=document.querySelector('[name="Line"]').value;
    const note=document.getElementById('equipNote');
    const equipSel=document.getElementById('equipmentSelect');

    if(!line){
      note.textContent='Select Line first to populate equipment';
      equipSel.disabled=true;
      return;
    }

    if(cat==='VI1_Types'){
      note.textContent='Equipment enabled for VI-1 stage';
      equipSel.disabled=false;
    } else {
      note.textContent='Equipment will be NA (only used for VI-1)';
      equipSel.disabled=true;
      equipSel.value='';
    }
  }

  function addItem(){
    const cat=document.getElementById('categorySelect').value;
    const type=document.getElementById('typeSelect').value;
    const equip=document.getElementById('equipmentSelect').value||'NA';
    const part=document.getElementById('partSelect').value||'';
    const qty=Number(document.getElementById('qtyInput').value||0);
    if(!cat||!type||qty<=0){alert('Stage, Type, Qty required');return;}
    items.push({category:cat,type:type,equipment:equip,cartridgePart:part,qty:qty});
    renderItems();
    document.getElementById('qtyInput').value='1';
  }

  function renderItems(){
    const tb=document.querySelector('#itemsTable tbody');
    if(items.length===0){
      tb.innerHTML='<tr><td colspan="7" style="text-align:center;color:#607182;padding:18px">No items added</td></tr>';
      return;
    }
    tb.innerHTML=items.map((r,i)=>`<tr>
      <td>${i+1}</td>
      <td><span class="stage-pill">${catMap[r.category]||r.category}</span></td>
      <td>${r.equipment||'NA'}</td>
      <td>${r.type}</td>
      <td>${r.cartridgePart||''}</td>
      <td>${r.qty}</td>
      <td><button type="button" class="remove-btn" onclick="delItem(${i})">Remove</button></td>
    </tr>`).join('');
  }

  function delItem(i){
    items.splice(i,1);
    renderItems();
  }

  function resetAddFields(){
    document.getElementById('categorySelect').value='';
    document.getElementById('typeSelect').innerHTML='';
    document.getElementById('equipmentSelect').value='';
    document.getElementById('partSelect').value='';
    document.getElementById('qtyInput').value='1';
    updateEquipNote();
  }

  function submitAll(){
    if(items.length===0){alert('Add items first');return;}
    const formObj=Object.fromEntries(new FormData(document.getElementById('mainForm')).entries());
    formObj.RejectionDetails=JSON.stringify(items);
    setStatus('Saving...',false);
    google.script.run.withSuccessHandler(res=>{
      setStatus(res.message||'Saved',true);
      items=[]; renderItems();
      document.getElementById('mainForm').reset();
      const d=new Date(); document.querySelector('[name="Date"]').value=d.toISOString().slice(0,10);
    }).withFailureHandler(err=>{
      setStatus('Error: '+(err.message||err),false,true);
    }).submitEntry(formObj);
  }

  function setStatus(msg,ok=false,err=false){
    const el=document.getElementById('status');
    el.textContent=msg;
    el.className='';
    if(ok) el.classList.add('ok');
    if(err) el.classList.add('err');
  }

  function formReset(){
    if(!confirm('Clear form and items?')) return;
    document.getElementById('mainForm').reset();
    items=[];
    renderItems();
    const d=new Date(); document.querySelector('[name="Date"]').value=d.toISOString().slice(0,10);
    setStatus('Ready');
  }

  function switchTab(evt){
    document.querySelectorAll('.tab-btn').forEach(btn=>btn.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(panel=>panel.classList.remove('active'));
    evt.currentTarget.classList.add('active');
    document.getElementById(evt.currentTarget.dataset.target).classList.add('active');
  }

  function fetchSummary(){
    const batch=document.getElementById('summaryBatch').value.trim();
    const statusEl=document.getElementById('summaryStatus');
    const table=document.getElementById('summaryTable');
    if(!batch){alert('Enter batch number');return;}
    statusEl.textContent='Loading...';
    table.style.display='none';
    google.script.run.withSuccessHandler(res=>{
      if(res.status!=='success'){
        statusEl.textContent=res.message||'No data found.';
        return;
      }
      const rows=Object.entries(res.totals).map(([stage,qty])=>`<tr><td>${stage}</td><td>${qty}</td></tr>`).join('');
      document.querySelector('#summaryTable tbody').innerHTML=rows;
      document.getElementById('summaryTotal').textContent=res.overall;
      statusEl.textContent='Totals for '+res.batch;
      table.style.display='table';
    }).withFailureHandler(err=>{
      statusEl.textContent='Error: '+(err.message||err);
    }).getBatchSummary(batch);
  }

  function fetchBrcStatus(){
    const batch=document.getElementById('brcBatch').value.trim();
    const statusEl=document.getElementById('brcStatusMessage');
    const details=document.getElementById('brcDetails');
    const batchSection=document.getElementById('batchDetailsSection');
    const trackerSection=document.getElementById('trackerSection');
    if(!batch){alert('Enter batch number');return;}
    statusEl.textContent='Checking...';
    details.style.display='none';
    currentBrcBatch=batch;
    batchSection.style.display='block';
    trackerSection.style.display='block';
    loadBatchDetails(batch);
    loadBrcTracker(batch);
    google.script.run.withSuccessHandler(res=>{
      if(res.status!=='success'){
        statusEl.textContent=res.message||'No BRC status available.';
        return;
      }
      const data=res.data||{};
      document.getElementById('brcStatusValue').textContent=data.status||'-';
      document.getElementById('brcRemarksValue').textContent=data.remarks||'-';
      document.getElementById('brcUpdatedValue').textContent=data.updatedOn||'-';
      statusEl.textContent='BRC details for '+res.batch;
      details.style.display='flex';
    }).withFailureHandler(err=>{
      statusEl.textContent='Error: '+(err.message||err);
    }).getBrcStatus(batch);
  }

  function loadBatchDetails(batch){
    const section=document.getElementById('batchDetailsSection');
    const statusEl=document.getElementById('batchDetailsStatus');
    section.style.display='block';
    statusEl.textContent='Loading batch details...';
    resetBatchDetailsForm();
    google.script.run.withSuccessHandler(res=>{
      if(res.status==='success'){
        const data=res.data||{};
        document.getElementById('incidentInput').value=data.incident||'';
        document.getElementById('deviationInput').value=data.deviation||'';
        document.getElementById('caInput').value=data.ca||'';
        document.getElementById('paInput').value=data.pa||'';
        document.getElementById('oosInput').value=data.oos||'';
        statusEl.textContent='Last updated: '+(data.updatedOn||'N/A');
      } else {
        statusEl.textContent=res.message||'No details yet. Enter and save below.';
      }
    }).withFailureHandler(err=>{
      statusEl.textContent='Error: '+(err.message||err);
    }).getBatchDetails(batch);
  }

  function loadBrcTracker(batch){
    const statusEl=document.getElementById('trackerStatusMsg');
    statusEl.textContent='Loading tracker...';
    setTrackerChecks(false,false);
    google.script.run.withSuccessHandler(res=>{
      if(res.status==='success'){
        const data=res.data||{};
        setTrackerChecks(!!data.submitted, !!data.gdp);
        statusEl.textContent='Tracker last updated: '+(data.updatedOn||'N/A');
      } else {
        statusEl.textContent=res.message||'No tracker data yet.';
      }
    }).withFailureHandler(err=>{
      statusEl.textContent='Error: '+(err.message||err);
    }).getBrcTracker(batch);
  }

  function setTrackerChecks(submitted,gdp){
    document.getElementById('brcSubmittedChk').checked=submitted;
    document.getElementById('gdpCompletedChk').checked=gdp;
  }

  function saveBrcTrackerStatus(){
    if(!currentBrcBatch){alert('Load BRC status first');return;}
    const payload={
      BatchNo:currentBrcBatch,
      BrcSubmitted:document.getElementById('brcSubmittedChk').checked,
      GdpCompleted:document.getElementById('gdpCompletedChk').checked
    };
    const statusEl=document.getElementById('trackerStatusMsg');
    statusEl.textContent='Saving tracker...';
    google.script.run.withSuccessHandler(res=>{
      statusEl.textContent=res.status==='success' ? 'Tracker saved.' : (res.message||'Unable to save.');
      if(res.status==='success') loadBrcTracker(currentBrcBatch);
    }).withFailureHandler(err=>{
      statusEl.textContent='Error: '+(err.message||err);
    }).saveBrcTracker(payload);
  }

  function saveBatchDetails(){
    if(!currentBrcBatch){alert('Load BRC status first');return;}
    const payload={
      BatchNo:currentBrcBatch,
      IncidentNumber:document.getElementById('incidentInput').value.trim(),
      DeviationNumber:document.getElementById('deviationInput').value.trim(),
      CANumber:document.getElementById('caInput').value.trim(),
      PANumber:document.getElementById('paInput').value.trim(),
      OOSNumber:document.getElementById('oosInput').value.trim()
    };
    const statusEl=document.getElementById('batchDetailsStatus');
    statusEl.textContent='Saving...';
    google.script.run.withSuccessHandler(res=>{
      if(res.status==='success'){
        statusEl.textContent='Saved at '+new Date().toLocaleString();
        loadBatchDetails(currentBrcBatch);
      } else {
        statusEl.textContent=res.message||'Unable to save.';
      }
    }).withFailureHandler(err=>{
      statusEl.textContent='Error: '+(err.message||err);
    }).saveBatchDetails(payload);
  }

  function resetBatchDetailsForm(){
    document.getElementById('incidentInput').value='';
    document.getElementById('deviationInput').value='';
    document.getElementById('caInput').value='';
    document.getElementById('paInput').value='';
    document.getElementById('oosInput').value='';
  }


  init();
</script>
</body>
</html>